{
 "Description": "Compute layer for serverless weather alert system",
 "Resources": {
  "RecipientsToLocationsFnServiceRole590C0D93": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/RecipientsToLocationsFn/ServiceRole/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "RecipientsToLocationsFnServiceRoleDefaultPolicy156B78C1": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:Query",
        "dynamodb:Scan"
       ],
       "Effect": "Allow",
       "Resource": [
        "arn:aws:dynamodb:us-east-1:423277768248:table/MumBaseTable",
        {
         "Ref": "AWS::NoValue"
        }
       ]
      },
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttLocationFetchQueue91236619ArnF5D7573C"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "RecipientsToLocationsFnServiceRoleDefaultPolicy156B78C1",
    "Roles": [
     {
      "Ref": "RecipientsToLocationsFnServiceRole590C0D93"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/RecipientsToLocationsFn/ServiceRole/DefaultPolicy/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      },
      {
       "reason": "Wildcard permissions required for CloudWatch Logs (log stream creation), DynamoDB queries, and Bedrock Knowledge Base access. Scoped to specific resources where possible.",
       "id": "AwsSolutions-IAM5",
       "applies_to": [
        "Resource::*",
        "Action::logs:CreateLogStream",
        "Action::logs:PutLogEvents",
        "Resource::arn:aws:bedrock:us-east-1:<AWS::AccountId>:knowledge-base/*"
       ]
      }
     ]
    }
   }
  },
  "RecipientsToLocationsFn3C2C0425": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-423277768248-us-east-1",
     "S3Key": "a9ec1d8c6f6304c24cb3adadcac3f75b271be0f110b5d0f2f2f5e9b7cd32ee7d.zip"
    },
    "Description": "Scans DynamoDB for recipient profiles and queues unique locations",
    "Environment": {
     "Variables": {
      "POWERTOOLS_SERVICE_NAME": "weather-alert-system",
      "LOG_LEVEL": "INFO",
      "RECIPIENTS_TABLE_NAME": "MumBaseTable",
      "MUM_TABLE_NAME": "MumBaseTable",
      "LOCATION_QUEUE_URL": {
       "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputRefLocationFetchQueue91236619E574A292"
      }
     }
    },
    "FunctionName": "WeatherAlert-RecipientsToLocations",
    "Handler": "index.lambda_handler",
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "RecipientsToLocationsFnServiceRole590C0D93",
      "Arn"
     ]
    },
    "Runtime": "python3.14",
    "Timeout": 300,
    "TracingConfig": {
     "Mode": "Active"
    }
   },
   "DependsOn": [
    "RecipientsToLocationsFnServiceRoleDefaultPolicy156B78C1",
    "RecipientsToLocationsFnServiceRole590C0D93"
   ],
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/RecipientsToLocationsFn/Resource",
    "aws:asset:path": "asset.a9ec1d8c6f6304c24cb3adadcac3f75b271be0f110b5d0f2f2f5e9b7cd32ee7d",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "RecipientsToLocationsFnLogRetentionC4D8E302": {
   "Type": "Custom::LogRetention",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A",
      "Arn"
     ]
    },
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/lambda/",
       {
        "Ref": "RecipientsToLocationsFn3C2C0425"
       }
      ]
     ]
    },
    "RetentionInDays": 7
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/RecipientsToLocationsFn/LogRetention/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "CDK-created log retention Lambda uses AWS managed policy. This is standard CDK behavior.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      }
     ]
    }
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:DeleteRetentionPolicy",
        "logs:PutRetentionPolicy"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB",
    "Roles": [
     {
      "Ref": "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/ServiceRole/DefaultPolicy/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "CDK-created log retention Lambda uses AWS managed policy. This is standard CDK behavior.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "CDK-created log retention Lambda requires wildcard for log management. This is standard CDK behavior.",
       "id": "AwsSolutions-IAM5",
       "applies_to": [
        "Resource::*"
       ]
      }
     ]
    }
   }
  },
  "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Handler": "index.handler",
    "Runtime": "nodejs22.x",
    "Timeout": 900,
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-423277768248-us-east-1",
     "S3Key": "2819175352ad1ce0dae768e83fc328fb70fb5f10b4a8ff0ccbcb791f02b0716d.zip"
    },
    "Role": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB",
      "Arn"
     ]
    }
   },
   "DependsOn": [
    "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRoleDefaultPolicyADDA7DEB",
    "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aServiceRole9741ECFB"
   ],
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8a/Resource",
    "aws:asset:path": "asset.2819175352ad1ce0dae768e83fc328fb70fb5f10b4a8ff0ccbcb791f02b0716d",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "DailyWeatherCheckRule48D6738A": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Triggers weather alert workflow daily",
    "Name": "WeatherAlert-DailyWeatherCheck",
    "ScheduleExpression": "cron(0 6 ? * * *)",
    "State": "ENABLED",
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "RecipientsToLocationsFn3C2C0425",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/DailyWeatherCheckRule/Resource"
   }
  },
  "DailyWeatherCheckRuleAllowEventRuleWeatherAlertComputeStackRecipientsToLocationsFn04B8D3EE6690B2C3": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "RecipientsToLocationsFn3C2C0425",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "DailyWeatherCheckRule48D6738A",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/DailyWeatherCheckRule/AllowEventRuleWeatherAlertComputeStackRecipientsToLocationsFn04B8D3EE"
   }
  },
  "WeatherFetchFnServiceRole37233A93": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/WeatherFetchFn/ServiceRole/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "WeatherFetchFnServiceRoleDefaultPolicyA3D580CD": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttWeatherResultQueueE0248ACEArn15DCF5A1"
       }
      },
      {
       "Action": [
        "secretsmanager:DescribeSecret",
        "secretsmanager:GetSecretValue"
       ],
       "Effect": "Allow",
       "Resource": "arn:aws:secretsmanager:us-east-1:423277768248:secret:weather-alert/api-key-??????"
      },
      {
       "Action": [
        "sqs:ChangeMessageVisibility",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:ReceiveMessage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttLocationFetchQueue91236619ArnF5D7573C"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "WeatherFetchFnServiceRoleDefaultPolicyA3D580CD",
    "Roles": [
     {
      "Ref": "WeatherFetchFnServiceRole37233A93"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/WeatherFetchFn/ServiceRole/DefaultPolicy/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      },
      {
       "reason": "Wildcard permissions required for CloudWatch Logs (log stream creation), DynamoDB queries, and Bedrock Knowledge Base access. Scoped to specific resources where possible.",
       "id": "AwsSolutions-IAM5",
       "applies_to": [
        "Resource::*",
        "Action::logs:CreateLogStream",
        "Action::logs:PutLogEvents",
        "Resource::arn:aws:bedrock:us-east-1:<AWS::AccountId>:knowledge-base/*"
       ]
      }
     ]
    }
   }
  },
  "WeatherFetchFnAA97F15F": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-423277768248-us-east-1",
     "S3Key": "6ec75d72e9199829f40d6df4f4ed55f1acdb43b91d30fed2e015e1e4e52a3010.zip"
    },
    "Description": "Fetches weather forecasts from Tomorrow.io API",
    "Environment": {
     "Variables": {
      "POWERTOOLS_SERVICE_NAME": "weather-alert-system",
      "LOG_LEVEL": "INFO",
      "WEATHER_RESULT_QUEUE_URL": {
       "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputRefWeatherResultQueueE0248ACE7A86D590"
      },
      "TEMP_THRESHOLD_C": "32",
      "TOMORROW_IO_API_KEY": "{{resolve:secretsmanager:arn:aws:secretsmanager:us-east-1:423277768248:secret:weather-alert/api-key:SecretString:::}}"
     }
    },
    "FunctionName": "WeatherAlert-WeatherFetch",
    "Handler": "index.lambda_handler",
    "MemorySize": 512,
    "ReservedConcurrentExecutions": 1,
    "Role": {
     "Fn::GetAtt": [
      "WeatherFetchFnServiceRole37233A93",
      "Arn"
     ]
    },
    "Runtime": "python3.14",
    "Timeout": 300,
    "TracingConfig": {
     "Mode": "Active"
    }
   },
   "DependsOn": [
    "WeatherFetchFnServiceRoleDefaultPolicyA3D580CD",
    "WeatherFetchFnServiceRole37233A93"
   ],
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/WeatherFetchFn/Resource",
    "aws:asset:path": "asset.6ec75d72e9199829f40d6df4f4ed55f1acdb43b91d30fed2e015e1e4e52a3010",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "WeatherFetchFnLogRetention174D2F33": {
   "Type": "Custom::LogRetention",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A",
      "Arn"
     ]
    },
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/lambda/",
       {
        "Ref": "WeatherFetchFnAA97F15F"
       }
      ]
     ]
    },
    "RetentionInDays": 7
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/WeatherFetchFn/LogRetention/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "WeatherFetchFnSqsEventSourceWeatherAlertDataStackLocationFetchQueueEE267A7FBF44DCE1": {
   "Type": "AWS::Lambda::EventSourceMapping",
   "Properties": {
    "BatchSize": 10,
    "EventSourceArn": {
     "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttLocationFetchQueue91236619ArnF5D7573C"
    },
    "FunctionName": {
     "Ref": "WeatherFetchFnAA97F15F"
    },
    "FunctionResponseTypes": [
     "ReportBatchItemFailures"
    ],
    "MaximumBatchingWindowInSeconds": 5
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/WeatherFetchFn/SqsEventSource:WeatherAlertDataStackLocationFetchQueueEE267A7F/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "MessageGeneratorFnServiceRole0503ACEF": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/MessageGeneratorFn/ServiceRole/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "MessageGeneratorFnServiceRoleDefaultPolicyFE4974EA": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "bedrock:InvokeModel",
        "bedrock:InvokeModelWithResponseStream"
       ],
       "Effect": "Allow",
       "Resource": "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
      },
      {
       "Action": "bedrock:Retrieve",
       "Effect": "Allow",
       "Resource": "arn:aws:bedrock:us-east-1:423277768248:knowledge-base/*"
      },
      {
       "Action": [
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:SendMessage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttNotifyQueueB34E1758Arn0733E2D4"
       }
      },
      {
       "Action": [
        "sqs:ChangeMessageVisibility",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl",
        "sqs:ReceiveMessage"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttWeatherResultQueueE0248ACEArn15DCF5A1"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "MessageGeneratorFnServiceRoleDefaultPolicyFE4974EA",
    "Roles": [
     {
      "Ref": "MessageGeneratorFnServiceRole0503ACEF"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/MessageGeneratorFn/ServiceRole/DefaultPolicy/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      },
      {
       "reason": "Wildcard permissions required for CloudWatch Logs (log stream creation), DynamoDB queries, and Bedrock Knowledge Base access. Scoped to specific resources where possible.",
       "id": "AwsSolutions-IAM5",
       "applies_to": [
        "Resource::*",
        "Action::logs:CreateLogStream",
        "Action::logs:PutLogEvents",
        "Resource::arn:aws:bedrock:us-east-1:<AWS::AccountId>:knowledge-base/*"
       ]
      }
     ]
    }
   }
  },
  "MessageGeneratorFn38C9DEB2": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-423277768248-us-east-1",
     "S3Key": "3b9a4816f57e16aa5f0a0bd044865b9282b6d5f918d86eb85bdd7a1cd3ce6f78.zip"
    },
    "Description": "Generates personalized messages using Bedrock KB and Claude",
    "Environment": {
     "Variables": {
      "POWERTOOLS_SERVICE_NAME": "weather-alert-system",
      "LOG_LEVEL": "INFO",
      "NOTIFY_QUEUE_URL": {
       "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputRefNotifyQueueB34E17580319ED30"
      },
      "BEDROCK_KNOWLEDGE_BASE_ID": {
       "Fn::ImportValue": "WeatherAlertBedrockKBId"
      },
      "BEDROCK_MODEL_ID": "anthropic.claude-3-sonnet-20240229-v1:0",
      "BEDROCK_SYSTEM_PROMPT": "You are a maternal health advisor providing supportive, actionable health advice to pregnant and postpartum mothers based on weather forecasts."
     }
    },
    "FunctionName": "WeatherAlert-MessageGenerator",
    "Handler": "index.lambda_handler",
    "MemorySize": 1024,
    "ReservedConcurrentExecutions": 2,
    "Role": {
     "Fn::GetAtt": [
      "MessageGeneratorFnServiceRole0503ACEF",
      "Arn"
     ]
    },
    "Runtime": "python3.14",
    "Timeout": 300,
    "TracingConfig": {
     "Mode": "Active"
    }
   },
   "DependsOn": [
    "MessageGeneratorFnServiceRoleDefaultPolicyFE4974EA",
    "MessageGeneratorFnServiceRole0503ACEF"
   ],
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/MessageGeneratorFn/Resource",
    "aws:asset:path": "asset.3b9a4816f57e16aa5f0a0bd044865b9282b6d5f918d86eb85bdd7a1cd3ce6f78",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "MessageGeneratorFnLogRetentionECCC39A0": {
   "Type": "Custom::LogRetention",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A",
      "Arn"
     ]
    },
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/lambda/",
       {
        "Ref": "MessageGeneratorFn38C9DEB2"
       }
      ]
     ]
    },
    "RetentionInDays": 7
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/MessageGeneratorFn/LogRetention/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "MessageGeneratorFnSqsEventSourceWeatherAlertDataStackWeatherResultQueueAC3128A2D1C095C2": {
   "Type": "AWS::Lambda::EventSourceMapping",
   "Properties": {
    "BatchSize": 5,
    "EventSourceArn": {
     "Fn::ImportValue": "WeatherAlertDataStack:ExportsOutputFnGetAttWeatherResultQueueE0248ACEArn15DCF5A1"
    },
    "FunctionName": {
     "Ref": "MessageGeneratorFn38C9DEB2"
    },
    "FunctionResponseTypes": [
     "ReportBatchItemFailures"
    ],
    "MaximumBatchingWindowInSeconds": 10
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/MessageGeneratorFn/SqsEventSource:WeatherAlertDataStackWeatherResultQueueAC3128A2/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "SendAdviceSMSFnServiceRoleA999FFCC": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/SendAdviceSMSFn/ServiceRole/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "SendAdviceSMSFnServiceRoleDefaultPolicyB27CE078": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "SendAdviceSMSFnServiceRoleDefaultPolicyB27CE078",
    "Roles": [
     {
      "Ref": "SendAdviceSMSFnServiceRoleA999FFCC"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/SendAdviceSMSFn/ServiceRole/DefaultPolicy/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      },
      {
       "reason": "Wildcard permissions required for CloudWatch Logs (log stream creation), DynamoDB queries, and Bedrock Knowledge Base access. Scoped to specific resources where possible.",
       "id": "AwsSolutions-IAM5",
       "applies_to": [
        "Resource::*",
        "Action::logs:CreateLogStream",
        "Action::logs:PutLogEvents",
        "Resource::arn:aws:bedrock:us-east-1:<AWS::AccountId>:knowledge-base/*"
       ]
      }
     ]
    }
   }
  },
  "SendAdviceSMSFn1E4B7F74": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-423277768248-us-east-1",
     "S3Key": "bde8e9f2d8dd7006224be8cf3d7d7618dc1b66238ea28c82537d1f3b2ff1ace8.zip"
    },
    "Description": "Sends SMS notifications via Africas Talking",
    "Environment": {
     "Variables": {
      "POWERTOOLS_SERVICE_NAME": "weather-alert-system",
      "LOG_LEVEL": "INFO",
      "AT_API_KEY": "NOT_CONFIGURED",
      "AT_USERNAME": "NOT_CONFIGURED",
      "AT_SENDER_ID": "WeatherAlert"
     }
    },
    "FunctionName": "WeatherAlert-SendSMS",
    "Handler": "index.lambda_handler",
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "SendAdviceSMSFnServiceRoleA999FFCC",
      "Arn"
     ]
    },
    "Runtime": "python3.14",
    "Timeout": 300,
    "TracingConfig": {
     "Mode": "Active"
    }
   },
   "DependsOn": [
    "SendAdviceSMSFnServiceRoleDefaultPolicyB27CE078",
    "SendAdviceSMSFnServiceRoleA999FFCC"
   ],
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/SendAdviceSMSFn/Resource",
    "aws:asset:path": "asset.bde8e9f2d8dd7006224be8cf3d7d7618dc1b66238ea28c82537d1f3b2ff1ace8",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "SendAdviceSMSFnLogRetention8F012E67": {
   "Type": "Custom::LogRetention",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "LogRetentionaae0aa3c5b4d4f87b02d85b201efdd8aFD4BFC8A",
      "Arn"
     ]
    },
    "LogGroupName": {
     "Fn::Join": [
      "",
      [
       "/aws/lambda/",
       {
        "Ref": "SendAdviceSMSFn1E4B7F74"
       }
      ]
     ]
    },
    "RetentionInDays": 7
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/SendAdviceSMSFn/LogRetention/Resource",
    "cdk_nag": {
     "rules_to_suppress": [
      {
       "reason": "AWSLambdaBasicExecutionRole is AWS managed policy for Lambda execution. Required for CloudWatch Logs access.",
       "id": "AwsSolutions-IAM4",
       "applies_to": [
        "Policy::arn:<AWS::Partition>:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      },
      {
       "reason": "Python 3.12 is the latest stable runtime. This warning is a false positive.",
       "id": "AwsSolutions-L1"
      }
     ]
    }
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/2VP0WrDMAz8lr47Wue87HUt21PHivMBRXXU4MaxQyS3jOB/H/bKGOzpTuLudNKgdQvbDd65sf3YeHeGtRO0ozLEMS2WFN75tHqczj3C+p6CFReD2l/CX36kZXLMZXq7UZCuej9wnl0YiuD/NiuHE6wmeiqCisfonf2qgZVlxe0JmUkYXgsobmGX7EiyQybl48BwiIMhoVC7ULnDsJr0iE2eclbV3AkOjzq/3+0v4TPJnCSrEHuCKz/dnl9Ab0Fvruxcs6QgbiIwP/gNInAMMDIBAAA="
   },
   "Metadata": {
    "aws:cdk:path": "WeatherAlertComputeStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "ProfilesToLocationsFnArn": {
   "Description": "ARN of ProfilesToLocations Lambda",
   "Value": {
    "Fn::GetAtt": [
     "RecipientsToLocationsFn3C2C0425",
     "Arn"
    ]
   }
  },
  "WeatherFetchFnArn": {
   "Description": "ARN of WeatherFetch Lambda",
   "Value": {
    "Fn::GetAtt": [
     "WeatherFetchFnAA97F15F",
     "Arn"
    ]
   }
  },
  "AdviceFnArn": {
   "Description": "ARN of Advice Lambda",
   "Value": {
    "Fn::GetAtt": [
     "MessageGeneratorFn38C9DEB2",
     "Arn"
    ]
   }
  },
  "ExportsOutputRefRecipientsToLocationsFn3C2C04256AF80DD8": {
   "Value": {
    "Ref": "RecipientsToLocationsFn3C2C0425"
   },
   "Export": {
    "Name": "WeatherAlertComputeStack:ExportsOutputRefRecipientsToLocationsFn3C2C04256AF80DD8"
   }
  },
  "ExportsOutputRefWeatherFetchFnAA97F15F1DA3CD93": {
   "Value": {
    "Ref": "WeatherFetchFnAA97F15F"
   },
   "Export": {
    "Name": "WeatherAlertComputeStack:ExportsOutputRefWeatherFetchFnAA97F15F1DA3CD93"
   }
  },
  "ExportsOutputRefMessageGeneratorFn38C9DEB2DA8EDFEC": {
   "Value": {
    "Ref": "MessageGeneratorFn38C9DEB2"
   },
   "Export": {
    "Name": "WeatherAlertComputeStack:ExportsOutputRefMessageGeneratorFn38C9DEB2DA8EDFEC"
   }
  },
  "ExportsOutputRefSendAdviceSMSFn1E4B7F74D99686BA": {
   "Value": {
    "Ref": "SendAdviceSMSFn1E4B7F74"
   },
   "Export": {
    "Name": "WeatherAlertComputeStack:ExportsOutputRefSendAdviceSMSFn1E4B7F74D99686BA"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}